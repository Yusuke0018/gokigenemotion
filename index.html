<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- 
    ご機嫌マスター - 非認知脳トレーニングアプリ（改修版）
    
    【概要】
    辻秀一先生の理論に基づく3つの基本練習を実践するWebアプリ
    - 感情に気づく（快・不快）
    - ご機嫌の価値を知る
    - 今ここ自分を意識する
    
    【主な改修点】
    1. ファビコン修正：スマホ等でファビコンが正しく表示されない問題を修正。SVGアイコンと互換性の高いPNGアイコン設定に変更しました。
    2. レスポンシブ改善：スマホ表示でレベル名が改行される問題を修正しました。
    3. スワイプナビゲーション：左右のスワイプでセクションを移動できるようになりました。
    4. UI/UX改善：セクション間の移動をスライドアニメーションに変更し、より滑らかな操作感を実現しました。
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ご機嫌マスター</title>

    <!-- --- ファビコンとPWAアイコン設定 (修正版) --- -->
    <!-- テーマカラー -->
    <meta name="theme-color" content="#ff6b6b">

    <!-- メインのSVGアイコン (最新のブラウザ向け) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%23ff6b6b'/%3E%3Cpath d='M9 18 C11 23, 21 23, 23 18' stroke='white' stroke-width='2.5' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='12' cy='14' r='2.5' fill='white'/%3E%3Ccircle cx='20' cy='14' r='2.5' fill='white'/%3E%3C/svg%3E">

    <!-- iOSのホーム画面用アイコン -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://placehold.co/180x180/ff6b6b/ffffff?text=%E2%98%85&font=noto">

    <!-- その他のPNGアイコン (下位互換性のため) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://placehold.co/32x32/ff6b6b/ffffff?text=%E2%98%85&font=noto">
    <link rel="icon" type="image/png" sizes="16x16" href="https://placehold.co/16x16/ff6b6b/ffffff?text=%E2%98%85&font=noto">
    
    <!-- PWAマニフェストファイル -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22%E3%81%94%E6%A9%9F%E5%AB%8C%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%22%2C%22short_name%22%3A%22%E3%81%94%E6%A9%9F%E5%AB%8C%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231a1a2e%22%2C%22theme_color%22%3A%22%231a1a2e%22%2C%22description%22%3A%22%E9%9D%9E%E8%AA%8D%E7%9F%A5%E8%84%B3%E3%82%92%E9%8D%9B%E3%81%88%E3%81%A6%E3%81%94%E6%A9%9F%E5%AB%8C%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AA%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A//placehold.co/192x192/ff6b6b/ffffff%3Ftext%3D%25E2%2598%2585%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/png%22%2C%22purpose%22%3A%22any%20maskable%22%7D%2C%7B%22src%22%3A%22https%3A//placehold.co/512x512/ff6b6b/ffffff%3Ftext%3D%25E2%2598%2585%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image/png%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
    <!-- --- ファビコン設定ここまで --- -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap');

        :root {
            --primary: #ff6b6b;
            --primary-light: #ff8787;
            --primary-dark: #ee5a5a;
            --secondary: #4ecdc4;
            --accent: #ffe66d;
            --background: #1a1a2e;
            --surface: #16213e;
            --surface-light: #0f3460;
            --surface-lighter: #1e3a5f;
            --text: #f5f5f5;
            --text-dim: #a8a8a8;
            --success: #51cf66;
            --warning: #ff6b6b;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warm: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Zen Maru Gothic', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 230, 109, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
            position: relative;
        }

        .header::after {
            content: '✨';
            position: absolute;
            top: -10px;
            right: 20%;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 900;
            background: var(--gradient-warm);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            letter-spacing: 0.02em;
            text-shadow: 2px 2px 20px rgba(255, 107, 107, 0.3);
        }

        .header p {
            color: var(--text-dim);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .navigation {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(30, 58, 95, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .nav-button {
            flex: 1;
            padding: 14px 20px;
            background: var(--surface);
            border: 2px solid transparent;
            border-radius: 15px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 0.95rem;
            font-weight: 500;
            min-width: 90px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 107, 107, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .nav-button:hover::before {
            width: 100%;
            height: 100%;
        }

        .nav-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.2);
        }

        .nav-button.active {
            background: var(--gradient-warm);
            color: white;
            box-shadow: 0 8px 30px rgba(255, 107, 107, 0.4);
            transform: translateY(-2px);
        }

        /* --- スワイプ機能のための新しいスタイル --- */
        .sections-wrapper {
            overflow: hidden;
            position: relative;
        }
        .sections-container {
            display: flex;
            /* JavaScriptで動的に設定されます */
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .section {
            /* JavaScriptで動的に設定されます */
            flex-shrink: 0;
            /* 元々の 'display: none' は不要になります */
            animation: fadeIn 0.6s ease;
        }
        
        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: slideUp 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gradient-warm);
            border-radius: 20px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 0.1;
        }

        .card h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '�';
            font-size: 1.5rem;
        }

        .emotion-main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .emotion-button {
            padding: 50px;
            font-size: 3.5rem;
            background: var(--surface-light);
            border: 3px solid transparent;
            border-radius: 20px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            backdrop-filter: blur(5px);
        }
        .emotion-button > span {
            font-size: 1.6rem;
            margin-top: 10px;
            display: block;
        }

        .emotion-button::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .emotion-button:hover::after {
            opacity: 1;
        }

        .emotion-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
            border-color: var(--secondary);
        }

        .emotion-button.selected {
            background: var(--gradient-warm);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
            transform: scale(1.05);
        }

        .emotion-button.selected::after {
            opacity: 1;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text);
            font-weight: 500;
            font-size: 1.05rem;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 15px 20px;
            background: rgba(15, 52, 96, 0.5);
            border: 2px solid var(--surface-lighter);
            border-radius: 15px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(15, 52, 96, 0.8);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
        }

        .button {
            padding: 15px 35px;
            background: var(--gradient-warm);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(1);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .button:hover::before {
            width: 300%;
            height: 300%;
        }

        .button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(255, 107, 107, 0.5);
        }

        .button:active {
            transform: translateY(-1px) scale(1.02);
        }

        .value-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 25px;
        }

        .value-tag {
            padding: 12px 22px;
            background: var(--surface-light);
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 500;
            animation: bounceIn 0.6s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative; /* For delete button positioning */
        }

        .value-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: var(--secondary);
        }

        .value-tag.big3 {
            background: var(--gradient-warm);
            color: white;
            font-weight: 700;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        .value-tag.big3::before {
            content: '⭐';
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background: var(--gradient-1);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .stat-card:nth-child(2) {
            background: var(--gradient-2);
        }

        .stat-card:nth-child(3) {
            background: var(--gradient-3);
        }

        .stat-card:nth-child(4) {
            background: var(--gradient-warm);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            margin-top: 5px;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-warm);
            transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        /* --- レスポンシブ改行対策 --- */
        .value-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap; /* これが改行を防ぐキー */
            margin-bottom: 10px;
            gap: 10px;
        }
        .value-progress-text {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
        }
        .value-progress-text .value-count {
            color: var(--accent);
            font-size: 1.3rem;
            font-weight: 700;
        }
        .value-level-badge {
            background: var(--gradient-warm);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            white-space: nowrap; /* バッジ内のテキストも改行させない */
            flex-shrink: 0; /* バッジが縮まないようにする */
        }
        
        .delete-button {
            display: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 107, 107, 0.2);
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.2rem;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .show-delete .delete-button {
            display: flex;
        }

        .delete-button:hover {
            background: var(--warning);
            color: white;
            transform: translateY(-50%) scale(1.1);
        }

        .emotion-record {
            padding: 15px 20px;
            background: var(--surface-lighter);
            border-radius: 15px;
            margin-top: 15px;
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .emotion-record:hover {
            border-color: var(--secondary);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-warm);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-warm);
            color: white;
            padding: 18px 25px;
            border-radius: 15px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: slideInDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            max-width: 90%;
            word-wrap: break-word;
            font-weight: 500;
        }

        .notification.error {
            background: var(--gradient-2);
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -120%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        @keyframes slideOutUp {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -120%);
            }
        }

        @keyframes levelUpPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes levelUpFade {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes sparkle {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% { 
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }


        /* --- レスポンシブデザイン --- */
        /* タブレット & 小型デスクトップ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .header h1 {
                font-size: 2.2rem;
            }
            .header p {
                font-size: 1rem;
            }
            .nav-button {
                font-size: 0.85rem;
                padding: 12px 15px;
                min-width: 70px;
            }
            .card {
                padding: 25px;
            }
            #record-now-btn {
                padding: 25px 50px;
                font-size: 1.6rem;
            }
        }
        
        /* スマートフォン */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .header p {
                font-size: 0.9rem;
            }
            .card {
                padding: 20px;
            }
            .emotion-main-grid {
                grid-template-columns: 1fr; /* 快・不快ボタンを縦積みに */
                gap: 15px;
            }
            .emotion-button {
                padding: 30px;
                font-size: 2.5rem;
            }
            .emotion-button > span {
                font-size: 1.2rem;
            }
            .stats-grid {
                grid-template-columns: 1fr; /* 統計カードを縦積みに */
            }
            .button {
                padding: 12px 30px;
                font-size: 1rem;
            }
             #record-now-btn {
                width: 100%;
                padding: 20px;
                font-size: 1.4rem;
            }
            .value-progress-text {
                font-size: 1rem;
            }
            .value-progress-text .value-count {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ご機嫌マスター</h1>
            <p>認知と非認知のバランスを整えて、ご機嫌な毎日を</p>
        </div>

        <div class="navigation">
            <button class="nav-button active" data-section="emotion">感情に気づく</button>
            <button class="nav-button" data-section="value">ご機嫌の価値</button>
            <button class="nav-button" data-section="now">今ここ自分</button>
            <button class="nav-button" data-section="stats">統計</button>
            <button class="nav-button" data-section="settings">設定</button>
        </div>

        <div class="sections-wrapper">
            <div class="sections-container">

                <!-- 感情に気づくセクション -->
                <div id="emotion-section" class="section">
                    <div class="card">
                        <h2>今の感情は？</h2>
                        <p style="color: var(--text-dim); margin-bottom: 25px;">
                            まずは快か不快かに気づき、詳しく言語化しましょう
                        </p>
                        
                        <div class="emotion-main-grid">
                            <button class="emotion-button" data-emoji="😊" data-name="快">
                                😊<br><span>快</span>
                            </button>
                            <button class="emotion-button" data-emoji="😔" data-name="不快">
                                😔<br><span>不快</span>
                            </button>
                        </div>

                        <div class="input-group">
                            <label>どんな快/不快？詳しく言語化してみましょう</label>
                            <textarea id="emotion-detail" rows="4" placeholder="例：プレゼンが終わってホッとした（快）/ 明日の会議を考えると胸がザワザワする（不快）"></textarea>
                        </div>

                        <button class="button" id="save-emotion-btn">感情を記録する</button>

                        <div id="emotion-history" style="margin-top: 35px;"></div>
                    </div>
                </div>

                <!-- ご機嫌の価値セクション -->
                <div id="value-section" class="section">
                    <div class="card">
                        <h2>ご機嫌でいると何が良い？</h2>
                        <p style="color: var(--text-dim); margin-bottom: 25px;">
                            価値リストは累積されます。10→30→50→100→300個でレベルアップ！
                        </p>

                        <div class="input-group">
                            <label>ご機嫌の価値を入力</label>
                            <input type="text" id="value-input" placeholder="例：アイデアが湧いてくる">
                        </div>

                        <button class="button" id="add-value-btn">価値を追加</button>

                        <div id="value-progress-container" style="margin-top: 25px;">
                            <!-- プログレスバーはこの中に動的に生成されます -->
                        </div>

                        <div id="value-list" class="value-list"></div>

                        <div style="margin-top: 35px;">
                            <h3 style="color: var(--accent); margin-bottom: 10px;">あなたのビッグ3を選択</h3>
                            <p style="color: var(--text-dim); font-size: 0.95rem;">特に大切な3つを選んでください（価値のテキスト部分をクリック）</p>
                        </div>
                    </div>
                </div>

                <!-- 今ここ自分セクション -->
                <div id="now-section" class="section">
                    <div class="card">
                        <h2>今ここ自分</h2>
                        <p style="color: var(--text-dim); margin-bottom: 30px;">
                            過去でも未来でもなく、今この瞬間に意識を向けましょう
                        </p>

                        <button class="button" id="record-now-btn" style="font-size: 1.8rem; padding: 30px 60px; border-radius: 30px;">
                            今・ここ・自分
                        </button>

                        <div style="margin-top: 40px;">
                            <h3 style="color: var(--secondary); margin-bottom: 20px;">今ここカウント</h3>
                            <div class="stat-card" style="background: var(--gradient-3);">
                                <div class="stat-number" id="now-count">0</div>
                                <div class="stat-label">今週の「今ここ自分」回数</div>
                            </div>
                        </div>

                        <div style="margin-top: 40px; background: var(--surface-lighter); padding: 25px; border-radius: 15px;">
                            <h3 style="color: var(--accent); margin-bottom: 20px;">簡単な瞑想ガイド</h3>
                            <div style="line-height: 2;">
                                <p>🌸 1. 深呼吸を3回</p>
                                <p>🌸 2. 「今」と心の中で唱える</p>
                                <p>🌸 3. 「ここ」と意識を体に向ける</p>
                                <p>🌸 4. 「自分」と自分の存在を感じる</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 統計セクション -->
                <div id="stats-section" class="section">
                    <div class="card">
                        <h2>あなたのご機嫌統計</h2>
                        <p id="week-period" style="color: var(--text-dim); margin-bottom: 25px; font-size: 1.05rem;"></p>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-emotions">0</div>
                                <div class="stat-label">今週の感情記録</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="positive-ratio">0%</div>
                                <div class="stat-label">今週の快の割合</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="total-values">0</div>
                                <div class="stat-label">累積価値リスト</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="now-count-stats">0</div>
                                <div class="stat-label">今週の今ここ回数</div>
                            </div>
                        </div>

                        <div style="margin-top: 35px;">
                            <h3 style="color: var(--secondary); margin-bottom: 20px;">今週の快・不快の内訳</h3>
                            <div id="emotion-trend"></div>
                        </div>

                        <div style="margin-top: 35px;">
                            <h3 style="color: var(--accent); margin-bottom: 20px;">過去の週の記録</h3>
                            <div id="history-weeks"></div>
                        </div>
                    </div>
                </div>

                <!-- 設定セクション -->
                <div id="settings-section" class="section">
                    <div class="card">
                        <h2>設定</h2>
                        
                        <div style="margin-bottom: 35px; background: var(--surface-lighter); padding: 25px; border-radius: 15px;">
                            <h3 style="color: var(--secondary); margin-bottom: 15px;">📁 データのバックアップ</h3>
                            <p style="color: var(--text-dim); margin-bottom: 20px;">
                                データをファイルとして保存し、後で復元できます
                            </p>
                            <button class="button" id="export-btn">データをエクスポート</button>
                        </div>
                        
                        <div style="margin-bottom: 35px; background: var(--surface-lighter); padding: 25px; border-radius: 15px;">
                            <h3 style="color: var(--secondary); margin-bottom: 15px;">📥 データの復元</h3>
                            <p style="color: var(--text-dim); margin-bottom: 20px;">
                                エクスポートしたファイルからデータを復元します
                            </p>
                            <input type="file" id="import-file" accept=".json" style="display: none;">
                            <button class="button" id="import-btn">
                                データをインポート
                            </button>
                        </div>
                        
                        <div style="background: rgba(255, 107, 107, 0.1); padding: 25px; border-radius: 15px; border: 2px solid rgba(255, 107, 107, 0.3);">
                            <h3 style="color: var(--warning); margin-bottom: 15px;">⚠️ データのリセット</h3>
                            <p style="color: var(--text-dim); margin-bottom: 20px;">
                                全てのデータを削除します（元に戻せません）
                            </p>
                            <button class="button" id="reset-btn" style="background: var(--gradient-2);">
                                全データを削除
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- グローバル変数と定数 ---
        const navButtons = Array.from(document.querySelectorAll('.nav-button'));
        const sectionIds = navButtons.map(btn => btn.dataset.section);
        const sectionsContainer = document.querySelector('.sections-container');
        const sections = document.querySelectorAll('.section');

        // --- 初期化とデータ管理 ---
        let appData = loadData() || {
            emotions: [],
            values: [],
            big3: [],
            nowCount: 0,
            selectedEmotion: null,
            weeklyData: {
                current: getWeekKey(),
                history: {}
            }
        };

        function loadData() {
            try {
                const saved = localStorage.getItem('gokigenMasterData');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (!data.weeklyData) {
                        data.weeklyData = { current: getWeekKey(), history: {} };
                    }
                    return data;
                }
            } catch (e) {
                console.error('データ読み込みエラー:', e);
            }
            return null;
        }

        function saveData() {
            try {
                localStorage.setItem('gokigenMasterData', JSON.stringify(appData));
            } catch (e) {
                console.error('データ保存エラー:', e);
                showNotification('データの保存に失敗しました', 'error');
            }
        }

        function getWeekKey() {
            const now = new Date();
            const monday = new Date(now);
            const day = monday.getDay() || 7;
            monday.setDate(monday.getDate() - day + 1);
            monday.setHours(0, 0, 0, 0);
            const year = monday.getFullYear();
            const month = (monday.getMonth() + 1).toString().padStart(2, '0');
            const date = monday.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${date}`;
        }

        function checkWeeklyReset() {
            const currentWeek = getWeekKey();
            if (appData.weeklyData.current !== currentWeek) {
                if (appData.weeklyData.current && (appData.emotions.length > 0 || appData.nowCount > 0)) {
                    appData.weeklyData.history[appData.weeklyData.current] = {
                        emotions: [...appData.emotions],
                        values: [...appData.values], // 週リセット時に価値も保存
                        big3: [...appData.big3],
                        nowCount: appData.nowCount,
                        endDate: new Date().toISOString()
                    };
                }
                appData.weeklyData.current = currentWeek;
                appData.nowCount = 0;
                appData.emotions = []; // 感情記録は週ごとにリセット
                showNotification('✨ 新しい週が始まりました！価値リストは継続されます。');
                saveData();
            }
        }

        // --- UI更新関数 ---
        function showSection(sectionId) {
            checkWeeklyReset();
            const sectionIndex = sectionIds.indexOf(sectionId);
            if (sectionIndex === -1) return;

            // セクションをスライド
            const percentage = sectionIndex * (100 / sectionIds.length);
            sectionsContainer.style.transform = `translateX(-${percentage}%)`;

            // ナビゲーションボタンを更新
            navButtons.forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-button[data-section="${sectionId}"]`).classList.add('active');

            // 必要に応じて各セクションのデータを更新
            if (sectionId === 'stats') updateStats();
            if (sectionId === 'now') document.getElementById('now-count').textContent = appData.nowCount;
        }

        function displayEmotionHistory() {
            const history = document.getElementById('emotion-history');
            const weekStart = new Date(appData.weeklyData.current);
            const weeklyEmotions = appData.emotions.filter(e => new Date(e.timestamp) >= weekStart);
            const recent = weeklyEmotions.slice(0, 5);
            
            history.innerHTML = '<h3 style="color: var(--secondary); margin-bottom: 20px;">今週の感情記録</h3>' +
                (recent.length > 0 ? recent.map(e => `
                    <div class="emotion-record" data-timestamp="${e.timestamp}">
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.8rem;">${e.emoji}</span>
                            <div style="margin-left: 15px;">
                                <strong style="font-size: 1.1rem;">${e.name}</strong>
                                <span style="color: var(--text-dim); font-size: 0.85rem; display: block;">${e.displayTime || new Date(e.timestamp).toLocaleString('ja-JP')}</span>
                            </div>
                        </div>
                        ${e.detail ? `<p style="margin-top: 10px; line-height: 1.6; padding-left: 50px; word-break: break-word;">${e.detail.replace(/\n/g, '<br>')}</p>` : ''}
                        <button class="delete-button">×</button>
                    </div>
                `).join('') : '<p style="color: var(--text-dim); margin-top: 10px; text-align: center;">まだ記録がありません</p>');
        }

        function displayValues() {
            const list = document.getElementById('value-list');
            list.innerHTML = appData.values.map((v, i) => 
                `<div class="value-tag ${appData.big3.includes(i) ? 'big3' : ''}" data-index="${i}">
                    <span>${v}</span>
                    <button class="delete-button">×</button>
                </div>`
            ).join('');
            updateValueProgress();
        }
        
        function updateValueProgress() {
            const container = document.getElementById('value-progress-container');
            const count = appData.values.length;
            const nextReq = getNextLevelRequirement(count);
            const currentLevel = getValueLevel(count);
            const levelName = getLevelName(currentLevel);
            const levelEmojis = ['', '🥉', '🥈', '🥇', '💎', '👑'];
            
            let progress = 0;
            let progressText = '';
            
            if (nextReq) {
                const levelStarts = [0, 10, 30, 50, 100, 300];
                const currentLevelStart = levelStarts[currentLevel] || 0;
                progress = ((count - currentLevelStart) / (nextReq - currentLevelStart)) * 100;
                progressText = `次のレベルまで：${nextReq - count}個`;
            } else {
                progress = 100;
                progressText = 'マスターレベル達成！';
            }
            
            // レスポンシブ改行対策済みのHTML
            container.innerHTML = `
                <div class="value-progress-header">
                    <p class="value-progress-text">
                        累積価値リスト（<span class="value-count">${count}</span>個）
                    </p>
                    <span class="value-level-badge">
                        ${levelEmojis[currentLevel]} ${levelName}
                    </span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <p style="color: var(--text-dim); font-size: 0.9rem; margin-top: 8px;">${progressText}</p>
            `;
        }

        function updateStats() {
            const weekStart = new Date(appData.weeklyData.current);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            document.getElementById('week-period').textContent = `今週：${weekStart.toLocaleDateString('ja-JP')} 〜 ${weekEnd.toLocaleDateString('ja-JP')}`;

            const weeklyEmotions = appData.emotions.filter(e => new Date(e.timestamp) >= weekStart);
            document.getElementById('total-emotions').textContent = weeklyEmotions.length;
            
            const positiveCount = weeklyEmotions.filter(e => e.name === '快').length;
            const ratio = weeklyEmotions.length > 0 ? Math.round((positiveCount / weeklyEmotions.length) * 100) : 0;
            document.getElementById('positive-ratio').textContent = `${ratio}%`;
            
            const currentLevel = getValueLevel(appData.values.length);
            const levelName = getLevelName(currentLevel);
            const levelEmojis = ['', '🥉', '🥈', '🥇', '💎', '👑'];
            document.getElementById('total-values').innerHTML = `${appData.values.length}<br><span style="font-size: 0.8rem;">${levelEmojis[currentLevel]}${levelName}</span>`;
            document.getElementById('now-count-stats').textContent = appData.nowCount;
            
            const trend = document.getElementById('emotion-trend');
            if (weeklyEmotions.length > 0) {
                const negativeCount = weeklyEmotions.length - positiveCount;
                const positivePercent = (positiveCount / weeklyEmotions.length) * 100;
                trend.innerHTML = `
                    <div style="display: flex; justify-content: space-around; margin-bottom: 25px; gap: 15px;">
                        <div style="text-align: center; background: var(--surface-lighter); padding: 25px; border-radius: 15px; flex: 1;">
                            <div style="font-size: 2.5rem;">😊</div><div style="font-size: 2rem; font-weight: 700; color: var(--success);">${positiveCount}回</div><div style="color: var(--text-dim); font-weight: 500;">快</div>
                        </div>
                        <div style="text-align: center; background: var(--surface-lighter); padding: 25px; border-radius: 15px; flex: 1;">
                            <div style="font-size: 2.5rem;">😔</div><div style="font-size: 2rem; font-weight: 700; color: var(--warning);">${negativeCount}回</div><div style="color: var(--text-dim); font-weight: 500;">不快</div>
                        </div>
                    </div>
                    <div class="progress-bar" style="height: 25px;"><div class="progress-fill" style="width: ${positivePercent}%; background: var(--gradient-3);"></div></div>
                    <p style="text-align: center; margin-top: 15px; color: var(--text); font-weight: 500;">快の割合: ${Math.round(positivePercent)}%</p>`;
            } else {
                trend.innerHTML = '<p style="color: var(--text-dim); text-align: center;">まだ記録がありません</p>';
            }

            const historyWeeks = document.getElementById('history-weeks');
            const historyKeys = Object.keys(appData.weeklyData.history).sort().reverse();
            if (historyKeys.length > 0) {
                historyWeeks.innerHTML = historyKeys.map(weekKey => {
                    const weekData = appData.weeklyData.history[weekKey];
                    const weekStartHist = new Date(weekKey);
                    const weekEndHist = new Date(weekStartHist);
                    weekEndHist.setDate(weekEndHist.getDate() + 6);
                    const positiveCountHist = weekData.emotions.filter(e => e.name === '快').length;
                    const positiveRatioHist = weekData.emotions.length > 0 ? Math.round((positiveCountHist / weekData.emotions.length) * 100) : 0;
                    const valueCountHist = weekData.values ? weekData.values.length : 0;
                    const nowCountHist = weekData.nowCount || 0;
                    return `<div class="card" style="margin-top: 25px; background: var(--surface-lighter);">
                                <h4 style="color: var(--accent); margin-bottom: 20px; font-size: 1.2rem;">📅 ${weekStartHist.toLocaleDateString('ja-JP')} 〜 ${weekEndHist.toLocaleDateString('ja-JP')}</h4>
                                <div class="stats-grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div class="stat-card" style="padding: 15px;"><div class="stat-number" style="font-size: 1.5rem;">${weekData.emotions.length}</div><div class="stat-label">感情記録</div></div>
                                    <div class="stat-card" style="padding: 15px;"><div class="stat-number" style="font-size: 1.5rem;">${positiveRatioHist}%</div><div class="stat-label">快の割合</div></div>
                                    <div class="stat-card" style="padding: 15px;"><div class="stat-number" style="font-size: 1.5rem;">${valueCountHist}</div><div class="stat-label">累積価値</div></div>
                                    <div class="stat-card" style="padding: 15px;"><div class="stat-number" style="font-size: 1.5rem;">${nowCountHist}</div><div class="stat-label">今ここ</div></div>
                                </div>
                            </div>`;
                }).join('');
            } else {
                historyWeeks.innerHTML = '<p style="color: var(--text-dim); text-align: center;">過去の記録はまだありません</p>';
            }
        }

        // --- アクション関数 ---
        function saveEmotion() {
            if (!appData.selectedEmotion) {
                showNotification('💭 感情を選択してください', 'error');
                return;
            }
            const detail = document.getElementById('emotion-detail').value;
            appData.emotions.unshift({
                ...appData.selectedEmotion,
                detail,
                timestamp: new Date().toISOString(),
                displayTime: new Date().toLocaleString('ja-JP')
            });
            displayEmotionHistory();
            document.querySelectorAll('.emotion-button').forEach(b => b.classList.remove('selected'));
            document.getElementById('emotion-detail').value = '';
            appData.selectedEmotion = null;
            showNotification('✨ 感情を記録しました！');
            saveData();
        }
        
        function deleteEmotion(timestamp) {
            const index = appData.emotions.findIndex(e => e.timestamp === timestamp);
            if (index > -1) {
                appData.emotions.splice(index, 1);
                displayEmotionHistory();
                showNotification('削除しました');
                saveData();
            }
        }

        function addValue() {
            const input = document.getElementById('value-input');
            const value = input.value.trim();
            if (!value) return;
            if (appData.values.includes(value)) {
                showNotification('💫 すでに追加されています', 'error');
                return;
            }
            const previousLevel = getValueLevel(appData.values.length);
            appData.values.push(value);
            const newLevel = getValueLevel(appData.values.length);
            input.value = '';
            displayValues();
            if (newLevel > previousLevel) {
                showLevelUpEffect(newLevel);
            } else {
                showNotification('🌟 価値を追加しました！');
            }
            saveData();
        }

        function deleteValue(index) {
            appData.big3 = appData.big3.filter(i => i !== index).map(i => i > index ? i - 1 : i);
            appData.values.splice(index, 1);
            displayValues();
            showNotification('削除しました');
            saveData();
        }

        function toggleBig3(index) {
            const idx = appData.big3.indexOf(index);
            const tag = document.querySelector(`.value-tag[data-index="${index}"]`);

            if (idx > -1) {
                appData.big3.splice(idx, 1);
                if(tag) tag.classList.remove('big3');
            } else if (appData.big3.length < 3) {
                appData.big3.push(index);
                if(tag) tag.classList.add('big3');
            } else {
                showNotification('⭐ ビッグ3は3つまでです', 'error');
                return;
            }
            saveData();
        }
        
        function recordNowHere() {
            appData.nowCount++;
            document.getElementById('now-count').textContent = appData.nowCount;
            showNotification('🌸 今・ここ・自分 を記録しました');
            saveData();
        }
        
        // --- ヘルパー関数 (レベル、通知、エフェクト) ---
        function getValueLevel(count) {
            if (count >= 300) return 5; if (count >= 100) return 4; if (count >= 50) return 3;
            if (count >= 30) return 2; if (count >= 10) return 1; return 0;
        }
        function getLevelName(level) {
            return ['ビギナー', 'ブロンズ', 'シルバー', 'ゴールド', 'プラチナ', 'マスター'][level] || 'ビギナー';
        }
        function getNextLevelRequirement(currentCount) {
            const levels = [10, 30, 50, 100, 300];
            for (let req of levels) { if (currentCount < req) return req; }
            return null;
        }
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutUp 0.5s forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        function showLevelUpEffect(level) {
            const levelName = getLevelName(level);
            const levelEmojis = ['', '🥉', '🥈', '🥇', '💎', '👑'];
            const notification = document.createElement('div');
            notification.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--gradient-warm); color: white; padding: 40px 60px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); z-index: 3000; text-align: center; animation: levelUpPop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);`;
            notification.innerHTML = `<div style="font-size: 4rem; margin-bottom: 20px;">${levelEmojis[level]}</div><h2 style="font-size: 2rem; margin-bottom: 10px;">レベルアップ！</h2><p style="font-size: 1.5rem; font-weight: 700;">${levelName}</p>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'levelUpFade 0.5s ease-out forwards';
                setTimeout(() => notification.remove(), 500);
            }, 2500);
        }

        // --- 設定関連の関数 ---
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gokigen-master-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
            showNotification('📁 データをエクスポートしました');
        }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    appData = imported;
                    saveData();
                    initializeAppState();
                    showNotification('📥 データをインポートしました');
                } catch (error) {
                    showNotification('ファイルの読み込みに失敗しました', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        function resetAllData() {
            if (confirm('本当にすべてのデータをリセットしますか？この操作は元に戻せません。')) {
                 localStorage.removeItem('gokigenMasterData');
                 window.location.reload();
            }
        }

        // --- イベントリスナー設定 ---
        function setupEventListeners() {
            document.querySelector('.navigation').addEventListener('click', (e) => {
                if (e.target.matches('.nav-button')) {
                    showSection(e.target.dataset.section);
                }
            });

            document.getElementById('emotion-section').addEventListener('click', (e) => {
                const button = e.target.closest('.emotion-button');
                if (button) {
                    document.querySelectorAll('.emotion-button').forEach(b => b.classList.remove('selected'));
                    button.classList.add('selected');
                    appData.selectedEmotion = { emoji: button.dataset.emoji, name: button.dataset.name };
                }
            });
            document.getElementById('save-emotion-btn').addEventListener('click', saveEmotion);

            document.getElementById('add-value-btn').addEventListener('click', addValue);
            document.getElementById('value-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addValue();
            });
            
            document.getElementById('record-now-btn').addEventListener('click', recordNowHere);

            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
            document.getElementById('import-file').addEventListener('change', importData);
            document.getElementById('reset-btn').addEventListener('click', resetAllData);

            document.body.addEventListener('click', (event) => {
                const target = event.target;
                const valueTag = target.closest('.value-tag');
                const emotionRecord = target.closest('.emotion-record');
                const clickedItem = valueTag || emotionRecord;

                document.querySelectorAll('.show-delete').forEach(el => {
                    if (el !== clickedItem) el.classList.remove('show-delete');
                });
                
                if (!clickedItem) return;

                if (target.matches('.delete-button')) {
                    if (valueTag) deleteValue(parseInt(valueTag.dataset.index, 10));
                    if (emotionRecord) deleteEmotion(emotionRecord.dataset.timestamp);
                    return;
                }

                if (valueTag) {
                    // ビッグ3選択はテキスト部分をクリックしたときだけにする
                    if(!target.matches('.delete-button')) {
                        toggleBig3(parseInt(valueTag.dataset.index, 10));
                    }
                }
                
                // 削除ボタン表示のトグル
                if (emotionRecord) {
                    clickedItem.classList.toggle('show-delete');
                }
            });

            // スワイプイベント
            let touchStartX = 0;
            �
</body>
</html>
